<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>RFID 刷卡上傳與查詢</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      padding: 30px;
    }

    input, button {
      font-size: 20px;
      margin: 10px;
      padding: 10px;
    }

    #rfidInput, #studentIdInput {
      font-size: 40px;
      width: 60%;
    }

    #status {
      font-size: 80px;
      font-weight: bold;
      margin-top: 40px;
    }

    .found { color: blue; }
    .not-found { color: red; }
    .error { color: orange; }

    #recordsTable {
      margin-top: 40px;
      width: 100%;
      border-collapse: collapse;
      font-size: 20px;
    }

    #recordsTable th, #recordsTable td {
      border: 1px solid #999;
      padding: 10px;
    }

    #recordsTable th {
      background-color: #eee;
    }

    .input-section {
      margin-bottom: 20px;
    }
    
    .latest-record {
      background-color: #ffffcc;
    }

    #wordContainer {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 100%;
      overflow: auto;
      text-align: left;
    }

    #wordViewer {
      width: 100%;
      min-height: 500px;
      padding: 20px;
      background-color: white;
    }

    .highlight-name {
      background-color: yellow;
      border: 2px solid red;
      border-radius: 3px;
      padding: 0 2px;
    }

    .word-controls {
      margin: 15px 0;
    }

    /* 保留Word原始樣式 */
    .word-content {
      font-family: inherit;
      white-space: normal;
    }
    .word-content p {
      margin: 0;
      padding: 0;
    }
    .word-content table {
      border-collapse: collapse;
      width: 100%;
    }
    .word-content table, .word-content th, .word-content td {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <h1>南山中學生活教育刷卡系統</h1>
  
  <div class="input-section">
    <h2>🔖 RFID刷卡</h2>
    <input type="text" id="rfidInput" autofocus placeholder="請刷卡" />
  </div>
  
  <div class="input-section">
    <h2>🆔 學號輸入</h2>
    <input type="text" id="studentIdInput" placeholder="請輸入學號" />
    <button onclick="submitStudentId()">提交</button>
  </div>
  
  <p id="status"></p>

  <audio id="successSound" src="success.mp3" preload="auto"></audio>
  <audio id="errorSound" src="error.mp3" preload="auto"></audio>

  <hr />
  <h2>📄 上傳生教名冊Word檔</h2>
  <input type="file" id="wordUpload" accept=".docx,.doc" />
  <button onclick="loadWord()">載入Word檔</button>
  
  <div id="wordContainer" style="display: none;">
    <div class="word-controls">
      <button onclick="downloadMarkedRoster()">下載已標記名冊</button>
      <span id="downloadStatus"></span>
    </div>
    <h3>名冊預覽</h3>
    <div id="wordViewer" class="word-content"></div>
  </div>

  <hr />
  <h2>📅 查詢刷卡紀錄</h2>
  <input type="date" id="queryDate" />
  <button onclick="queryRecords()">查詢</button>
  <button onclick="window.print()">列印</button>

  <table id="recordsTable">
    <thead>
      <tr>
        <th>班級</th>
        <th>學號</th>
        <th>姓名</th>
        <th>刷卡時間</th>
        <th>類型</th>
      </tr>
    </thead>
    <tbody id="recordsBody">
    </tbody>
  </table>

  <script>
    const { jsPDF } = window.jspdf;

    const firebaseConfig = {
      apiKey: "AIzaSyDIBZcv7FDus86I_tqMNdGaTGLFUH9TkGg",
      authDomain: "new123-88a1a.firebaseapp.com",
      databaseURL: "https://new123-88a1a-default-rtdb.firebaseio.com",
      projectId: "new123-88a1a",
      storageBucket: "new123-88a1a.appspot.com",
      messagingSenderId: "1098459270837",
      appId: "1:1098459270837:web:51532d8f2cffbf9271b8fc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const rfidInput = document.getElementById("rfidInput");
    const studentIdInput = document.getElementById("studentIdInput");
    const status = document.getElementById("status");
    const successSound = document.getElementById("successSound");
    const errorSound = document.getElementById("errorSound");
    const wordContainer = document.getElementById("wordContainer");
    const wordViewer = document.getElementById("wordViewer");
    const downloadStatus = document.getElementById("downloadStatus");

    let clearTimer = null;
    let latestRecordId = null;
    let highlightedNames = new Set();
    let originalWordHtml = "";

    // RFID刷卡處理
    rfidInput.addEventListener("keydown", async function (event) {
      if (event.key === "Enter") {
        const rfid = rfidInput.value.trim();
        if (rfid !== "") {
          await processInput(rfid, "rfid");
        }
      }
    });

    // 學號輸入處理
    studentIdInput.addEventListener("keydown", async function (event) {
      if (event.key === "Enter") {
        await submitStudentId();
      }
    });

    // 學號提交處理
    async function submitStudentId() {
      const studentId = studentIdInput.value.trim();
      if (studentId !== "") {
        await processInput(studentId, "studentId");
      }
    }

    // 通用輸入處理函數
    async function processInput(inputValue, inputType) {
      try {
        let querySnapshot;
        let studentName = null;
        
        if (inputType === "rfid") {
          querySnapshot = await db.collection("students").where("rfid", "==", inputValue).get();
        } else {
          querySnapshot = await db.collection("students").where("studentId", "==", inputValue).get();
        }
        
        status.className = "";
        clearTimeout(clearTimer);

        if (!querySnapshot.empty) {
          const data = querySnapshot.docs[0].data();
          studentName = data.name;
          status.textContent = `班級：${data.class}，學號：${data.studentId}，姓名：${data.name}`;
          status.classList.add("found");
          successSound.play();

          const docRef = await db.collection("rfid_records").add({
            rfid: data.rfid || null,
            class: data.class,
            studentId: data.studentId,
            name: data.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inputType: inputType
          });
          latestRecordId = docRef.id;
        } else {
          status.textContent = `查無資料，${inputType === "rfid" ? "RFID" : "學號"}：${inputValue}`;
          status.classList.add("not-found");
          errorSound.play();

          const docRef = await db.collection("rfid_records").add({
            rfid: inputType === "rfid" ? inputValue : null,
            class: null,
            studentId: inputType === "studentId" ? inputValue : null,
            name: null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inputType: inputType
          });
          latestRecordId = docRef.id;
        }

        if (studentName && wordViewer.innerHTML) {
          highlightNameInWord(studentName);
        }

        await queryRecords();

        clearTimer = setTimeout(() => {
          status.textContent = "";
          status.className = "";
        }, 3000);

        if (inputType === "rfid") {
          rfidInput.value = "";
          rfidInput.focus();
        } else {
          studentIdInput.value = "";
          studentIdInput.focus();
        }
      } catch (error) {
        status.textContent = "操作失敗：" + error.message;
        status.className = "error";
        errorSound.play();

        clearTimer = setTimeout(() => {
          status.textContent = "";
          status.className = "";
        }, 3000);
      }
    }

    // 載入Word文件並保留格式
    async function loadWord() {
      const fileInput = document.getElementById("wordUpload");
      const file = fileInput.files[0];
      
      if (!file) {
        alert("請先選擇Word文件");
        return;
      }

      try {
        downloadStatus.textContent = "正在載入Word檔...";
        
        const arrayBuffer = await file.arrayBuffer();
        
        // 使用mammoth.js將Word轉換為HTML並保留格式
        const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
        
        // 保存原始HTML以便重新標記
        originalWordHtml = result.value;
        
        // 顯示轉換後的HTML
        wordViewer.innerHTML = originalWordHtml;
        highlightedNames.clear();
        
        wordContainer.style.display = "block";
        downloadStatus.textContent = "Word檔載入完成！";
        
        setTimeout(() => {
          downloadStatus.textContent = "";
        }, 3000);
      } catch (error) {
        console.error("Word檔載入失敗:", error);
        downloadStatus.textContent = "Word檔載入失敗: " + error.message;
      }
    }

    // 在Word內容中高亮顯示姓名（保留原始格式）
    function highlightNameInWord(name) {
      if (highlightedNames.has(name)) {
        return;
      }
      
      // 重置為原始HTML
      wordViewer.innerHTML = originalWordHtml;
      
      // 標記所有找到的姓名
      const regex = new RegExp(escapeRegExp(name), "g");
      wordViewer.innerHTML = wordViewer.innerHTML.replace(
        regex, 
        `<span class="highlight-name">${name}</span>`
      );
      
      highlightedNames.add(name);
      
      // 更新原始HTML以包含新的標記
      originalWordHtml = wordViewer.innerHTML;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 下載已標記的名冊
    async function downloadMarkedRoster() {
  if (!wordViewer || wordViewer.innerHTML === "") {
    downloadStatus.textContent = "沒有可下載的名冊";
    return;
  }

  downloadStatus.textContent = "正在生成檔案...";
  
  try {
    // 創建 Blob 對象 (HTML格式)
    const content = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>已標記名冊</title>
        <style>
          body { font-family: "Microsoft JhengHei", Arial, sans-serif; }
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid black; padding: 5px; text-align: center; }
          .highlight-name { background-color: yellow; border: 2px solid red; }
        </style>
      </head>
      <body>
        ${wordViewer.innerHTML}
      </body>
      </html>
    `;
    
    // 創建下載連結
    const blob = new Blob([content], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `已標記名冊_${new Date().toLocaleDateString('zh-TW')}.html`;
    document.body.appendChild(a);
    a.click();
    
    // 清理
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      downloadStatus.textContent = "下載完成！";
      setTimeout(() => { downloadStatus.textContent = ""; }, 3000);
    }, 100);
  } catch (error) {
    console.error("生成檔案失敗:", error);
    downloadStatus.textContent = "下載失敗: " + error.message;
  }
}

    async function queryRecords() {
      const dateStr = document.getElementById("queryDate").value;
      if (!dateStr) {
        const today = new Date();
        const dateInput = document.getElementById("queryDate");
        dateInput.valueAsDate = today;
        return await queryRecords();
      }

      const date = new Date(dateStr);
      const start = new Date(date.setHours(0, 0, 0, 0));
      const end = new Date(date.setHours(23, 59, 59, 999));

      const snapshot = await db.collection("rfid_records")
        .where("timestamp", ">=", start)
        .where("timestamp", "<=", end)
        .orderBy("timestamp", "desc")
        .get();

      const tbody = document.getElementById("recordsBody");
      tbody.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate().toLocaleTimeString("zh-TW") || "無時間";
        const inputType = data.inputType === "rfid" ? "RFID刷卡" : "學號輸入";

        const row = document.createElement("tr");
        if (doc.id === latestRecordId) {
          row.classList.add("latest-record");
        }
        row.innerHTML = `
          <td>${data.class || ""}</td>
          <td>${data.studentId || ""}</td>
          <td>${data.name || ""}</td>
          <td>${time}</td>
          <td>${inputType}</td>
        `;
        tbody.appendChild(row);
      });
      
      latestRecordId = null;
    }

    window.onload = function() {
      queryRecords();
    };
  </script>
</body>
</html>
